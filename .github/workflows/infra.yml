name: Infrastructure Pipeline

on:
  push:
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.plan.outputs.exitcode == 2 }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init
        working-directory: infra/terraform

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -detailed-exitcode -out=tfplan || exit_code=$?
          echo "exitcode=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 2 ]; then
            echo "Drift detected!"
          elif [ $exit_code -eq 1 ]; then
            echo "Terraform plan failed"
            exit 1
          else
            echo "No changes"
          fi
        working-directory: infra/terraform
        env:
          TF_VAR_ssh_host: ${{ secrets.SSH_HOST }}
          TF_VAR_ssh_user: ${{ secrets.SSH_USER }}
          TF_VAR_ssh_private_key: 'key.pem'

      - name: Send Email on Drift
        if: steps.plan.outputs.exitcode == 2
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'Terraform Drift Detected'
          body: 'Drift detected in infrastructure. Please review and approve.'
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions

  terraform-apply:
    needs: terraform-plan
    if: needs.terraform-plan.outputs.drift_detected == 'true'
    runs-on: ubuntu-latest
    environment: production # Requires manual approval in GitHub
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Create SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > infra/terraform/key.pem
          chmod 600 infra/terraform/key.pem

      - name: Terraform Init
        run: terraform init
        working-directory: infra/terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: infra/terraform
        env:
          TF_VAR_ssh_host: ${{ secrets.SSH_HOST }}
          TF_VAR_ssh_user: ${{ secrets.SSH_USER }}
          TF_VAR_ssh_private_key: 'key.pem'
